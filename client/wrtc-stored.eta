<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><%= it.transport %> <%= it.videoType %> Video</title>
</head>
<body>
    <video id="video" width="750" controls></video>
    <script type="text/javascript">
        window.addEventListener('load', function () {
            const mimeCodec = 'video/mp4; codecs="avc1.4D401F, mp4a.40.2"';
            const mediaSource = new MediaSource();
            const video = document.querySelector('#video');
            video.src = URL.createObjectURL(mediaSource);

            const streamVideo = async (sourceBuffer) => {
                const configuration = {'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}]}
                const peerConnection = new RTCPeerConnection(configuration);
                signalingChannel.addEventListener('message', async message => {
                    console.log('got message', message);
                    if (message.answer) {
                        const remoteDesc = new RTCSessionDescription(message.answer);
                        await peerConnection.setRemoteDescription(remoteDesc);
                    }
                });
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                signalingChannel.send({'offer': offer});
                <% /* let i = 0;
                while(true) {
                    const { done, value } = await reader.read();
                    if(done) {
                        break;
                    }
                    i += value.length;
                    await new Promise((resolve) => {
                        sourceBuffer.onupdateend = () => resolve();
                        sourceBuffer.appendBuffer(value);
                    });
                }
                console.log('finished streaming video', i); */ %>
            }

            let sourceBuffer;
            mediaSource.onsourceopen = () => sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);

            let firstPlay = true;
            video.onplay = () => {
                if(firstPlay) {
                    streamVideo(sourceBuffer);
                    firstPlay = false;
                }
            }
        })
    </script>
</body>
</html>