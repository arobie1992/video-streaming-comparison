<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Stored Video</title>
</head>
<body>
    <video id="video" width="750" controls></video>
    <script type="text/javascript">
        window.addEventListener('load', function () {
            const mimeCodec = 'video/mp4; codecs="avc1.4D401F, mp4a.40.2"';
            const mediaSource = new MediaSource();
            const video = document.querySelector('#video');
            video.src = URL.createObjectURL(mediaSource);

            const streamVideo = (sourceBuffer) => {
                const ws = new WebSocket('ws://localhost:8080/stream');
                ws.onerror = e => console.log('error!', e);
                ws.binaryType = 'arraybuffer';
                const q = [];
                let l = 0;
                ws.onclose = async () => {
                    ws.close();
                    console.log('ws closed', 'received:', l);
                    if(!q.length) {
                        return;
                    }
                    sourceBuffer.onupdateend = () => {
                        if(q.length) {
                            sourceBuffer.appendBuffer(q.shift());
                        }
                    }
                    if(!sourceBuffer.updating) {
                        sourceBuffer.appendBuffer(q.shift());
                    }
                }
                let i = 0;
                ws.onmessage = e => {
                    const data = new Uint8Array(e.data);
                    l += data.length;
                    // i++;
                    // if(i === 200) {
                    //     return;
                    // }
                    q.push(data);
                    if(!sourceBuffer.updating) {
                        try {
                            sourceBuffer.appendBuffer(q.shift());
                        } catch(e) {
                            console.log(e);
                            throw e;
                        }
                        if(video.error) {
                            console.log(video.error);
                        }
                    }
                }
            }

            let sourceBuffer;
            mediaSource.onsourceopen = () => {
                sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
                sourceBuffer.onerror = e => console.log('sourceBuffer error', e);
            }

            let firstPlay = true;
            video.onplay = () => {
                if(firstPlay) {
                    streamVideo(sourceBuffer);
                    firstPlay = false;
                }
            }
        })
    </script>
</body>
</html>